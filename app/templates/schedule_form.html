{% extends "base.html" %}
{% set title = "Cadastro de Oferta" %}
{% block content %}
<form class="form" method="post" id="schedule-form" data-is-new="{{ 1 if not schedule else 0 }}" autocomplete="off">
  <div class="frame">
    <div class="frame-header">
      <h3>Cadastro de Oferta</h3>
    </div>
    <div class="form-row">
      <div>
        <label>ID</label>
        <input id="schedule-id" name="schedule_id" value="{{ schedule.id if schedule else schedule_id }}" readonly required />
      </div>
      <div>
        <label>Ano</label>
        <input name="ano" id="ano" class="guided-field" value="{{ schedule.ano if schedule else '' }}" required />
      </div>
      <div>
        <label>MÃªs</label>
        <select name="mes" class="guided-field" required>
          <option value="" {% if not schedule %}selected{% endif %}>Selecione</option>
          {% for month in months %}
            <option value="{{ month.value }}" {% if schedule and schedule.mes|string == month.value %}selected{% endif %}>{{ month.label }}</option>
          {% endfor %}
        </select>
      </div>
    </div>
  </div>

  <div class="frame">
    <div class="frame-header">
      <h3>Dados da Oferta</h3>
    </div>

    <div class="form-row oferta-row oferta-row-1">
      <div class="oferta-col oferta-col-turno">
        <label>Turno</label>
        <select name="turno_id" class="guided-field" required>
          <option value="" data-start="" data-end="" data-hs="" {% if not schedule %}selected{% endif %}>Selecione</option>
          {% for shift in shifts %}
            <option value="{{ shift.id }}" data-start="{{ shift.horario_inicio }}" data-end="{{ shift.horario_fim }}" data-hs="{{ shift.hs_dia }}" {% if schedule and schedule.turno_id == shift.id %}selected{% endif %}>{{ shift.nome }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="oferta-col oferta-col-ambiente">
        <label>Ambiente</label>
        <select name="sala_id" id="ambiente-select" class="guided-field" required>
          <option value="" data-floor="" data-capacity="" {% if not schedule %}selected{% endif %}>Selecione</option>
          {% for room in rooms %}
            <option value="{{ room.id }}" data-floor="{{ room.pavimento }}" data-capacity="{{ room.capacidade }}" {% if schedule and schedule.sala_id == room.id %}selected{% endif %}>{{ room.nome }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="oferta-col oferta-col-pavimento">
        <label>Pavimento</label>
        <input name="pavimento" id="pavimento" value="{{ schedule.pavimento if schedule else '' }}" readonly required />
      </div>
      <div class="oferta-col oferta-col-qtd">
        <label>QTD. Alunos</label>
        <input name="qtd_alunos" id="qtd-alunos" value="{{ schedule.qtd_alunos if schedule else '' }}" required />
      </div>
    </div>

    <div class="form-row oferta-row oferta-row-2">
      <div class="oferta-col oferta-col-curso">
        <label>Curso</label>
        <select name="curso_id" id="curso-select" class="guided-field" required>
          <option value="" data-ch="" {% if not schedule %}selected{% endif %}>Selecione</option>
          {% for course in courses %}
            <option value="{{ course.id }}" data-ch="{{ course.carga_horaria_total }}" {% if schedule and schedule.curso_id == course.id %}selected{% endif %}>{{ course.nome }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="oferta-col oferta-col-ch">
        <label>CH</label>
        <input name="ch_total" id="ch-total" value="{{ schedule.ch_total if schedule else '' }}" readonly required maxlength="6" />
      </div>
      <div class="oferta-col oferta-col-data">
        <label>Data Inicial (DD/MM/AAAA)</label>
        <input name="data_inicio" id="data-inicio" class="date-mask guided-field" value="{{ schedule.data_inicio if schedule else '' }}" required />
      </div>
      <div class="oferta-col oferta-col-data">
        <label>Data Final (DD/MM/AAAA)</label>
        <input name="data_fim" id="data-fim" class="date-mask" value="{{ schedule.data_fim if schedule else '' }}" required />
      </div>
    </div>

    <div class="form-row oferta-row oferta-row-3">
      <div class="oferta-col oferta-col-hora">
        <label>Hora Inicial</label>
        <input name="hora_inicio" id="hora-inicio" class="time-field" value="{{ schedule.hora_inicio if schedule else '' }}" type="time" required />
      </div>
      <div class="oferta-col oferta-col-hora">
        <label>Hora Final</label>
        <input name="hora_fim" id="hora-fim" class="time-field" value="{{ schedule.hora_fim if schedule else '' }}" type="time" required />
      </div>
      <div class="oferta-col oferta-col-hs">
        <label>Hs/Dia</label>
        <input id="hs-dia" class="time-field" value="{{ schedule.hs_dia if schedule else '' }}" readonly />
      </div>
      <div class="oferta-col oferta-col-turma">
        <label>Nº da Turma</label>
        <input name="turma" id="turma" value="{{ schedule.turma if schedule else '' }}" placeholder="0000.00.000" pattern="\d{4}\.\d{2}\.\d{3}" inputmode="numeric" required />
      </div>
      <div class="oferta-col oferta-col-analista">
        <label>Analista</label>
        <select name="analista_id" class="guided-field" required>
          <option value="" {% if not schedule %}selected{% endif %}>Selecione</option>
          {% for collaborator in analysts %}
            <option value="{{ collaborator.id }}" {% if schedule and schedule.analista_id == collaborator.id %}selected{% endif %}>{{ collaborator.nome_sobrenome }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="oferta-col oferta-col-instrutor">
        <label>Instrutor</label>
        {% set selected_instrutores = schedule.instrutor_ids if schedule and schedule.instrutor_ids else ([schedule.instrutor_id] if schedule and schedule.instrutor_id else []) %}
        <div id="instructors-list" class="instructors-list" data-count="{{ selected_instrutores|length if selected_instrutores else 1 }}">
          {% if selected_instrutores %}
            {% for selected_id in selected_instrutores %}
              <div class="instructor-row">
                <select name="instrutor_ids" class="guided-field" required>
                  <option value="">Selecione</option>
                  {% for collaborator in instructors %}
                    <option value="{{ collaborator.id }}" {% if selected_id == collaborator.id %}selected{% endif %}>{{ collaborator.nome_sobrenome }}</option>
                  {% endfor %}
                </select>
                <button type="button" class="button instructor-add instructor-add-primary">+</button>
                <button type="button" class="button ghost instructor-remove">-</button>
              </div>
            {% endfor %}
          {% else %}
            <div class="instructor-row">
              <select name="instrutor_ids" class="guided-field" required>
                <option value="">Selecione</option>
                {% for collaborator in instructors %}
                  <option value="{{ collaborator.id }}">{{ collaborator.nome_sobrenome }}</option>
                {% endfor %}
              </select>
              <button type="button" class="button instructor-add instructor-add-primary">+</button>
              <button type="button" class="button ghost instructor-remove">-</button>
            </div>
          {% endif %}
        </div>
      </div>
      <div class="oferta-col oferta-col-assistente">
        <label>Assistente</label>
        <select name="assistente_id" class="guided-field">
          <option value="" {% if not schedule or not schedule.assistente_id %}selected{% endif %}>Selecione</option>
          {% for collaborator in assistants %}
            <option value="{{ collaborator.id }}" {% if schedule and schedule.assistente_id == collaborator.id %}selected{% endif %}>{{ collaborator.nome_sobrenome }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <div class="form-row oferta-row oferta-row-4">
      <div class="oferta-col">
        <label>Recurso/Tipo</label>
        <input name="recurso_tipo" value="{{ schedule.recurso_tipo if schedule else '' }}" />
      </div>
      <div class="oferta-col">
        <label>Programa/Parceria</label>
        <input name="programa_parceria" value="{{ schedule.programa_parceria if schedule else '' }}" />
      </div>
    </div>

    <div class="form-row">
      <div>
        <label>Dias de execução</label>
        <div class="checkbox-grid">
          {% set dias = schedule.dias_execucao if schedule and schedule.dias_execucao else [] %}
          {% for day in ["SEG", "TER", "QUA", "QUI", "SEX", "SÁB"] %}
            <label class="checkbox-item">
              <input type="checkbox" name="dias_execucao" value="{{ day }}" {% if day in dias %}checked{% endif %} />
              <span>{{ day }}</span>
            </label>
          {% endfor %}
        </div>
      </div>
      <div>
        <label>Observações</label>
        <textarea name="observacoes">{{ schedule.observacoes if schedule else '' }}</textarea>
      </div>
    </div>
<div id="end-date-alert" class="alert" role="alert" style="display: none;"></div>
  </div>
  <div class="actions">
    <button class="button" type="submit">Salvar</button>
    <a class="button ghost" href="/programming">Cancelar</a>
  </div>
</form>

<style>
  .oferta-row {
    display: grid;
    gap: 10px;
    align-items: end;
  }
  .oferta-row .oferta-col > label {
    white-space: nowrap;
  }
  .oferta-row-1 {
    grid-template-columns: 130px minmax(280px, 1.1fr) 110px 110px;
  }
  .oferta-row-2 {
    grid-template-columns: minmax(300px, 1.2fr) 90px 175px 175px;
  }
  .oferta-row-3 {
    grid-template-columns: 115px 115px 90px 130px 1.1fr 1.4fr 1fr;
  }
  .oferta-row-4 {
    grid-template-columns: 1fr 1fr;
  }
  .oferta-col-ch input {
    max-width: 90px;
  }
  input.guided-field,
  select.guided-field,
  textarea.guided-field {
    background-color: #f5efe0 !important;
    transition: background-color .15s ease;
  }
  input.guided-field.is-filled,
  select.guided-field.is-filled,
  textarea.guided-field.is-filled {
    background-color: #fff !important;
  }
  .instructor-add-primary {
    background: #2563eb;
    border-color: #1d4ed8;
    color: #fff;
  }
  .instructor-add-primary:hover {
    background: #1d4ed8;
  }
  @media (max-width: 1200px) {
    .oferta-row-1,
    .oferta-row-2,
    .oferta-row-3,
    .oferta-row-4 {
      grid-template-columns: repeat(2, minmax(220px, 1fr));
    }
  }
  @media (max-width: 700px) {
    .oferta-row-1,
    .oferta-row-2,
    .oferta-row-3,
    .oferta-row-4 {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
  const ambienteSelect = document.getElementById("ambiente-select");
  const pavimentoInput = document.getElementById("pavimento");
  const qtdAlunosInput = document.getElementById("qtd-alunos");
  const cursoSelect = document.getElementById("curso-select");
  const chTotalInput = document.getElementById("ch-total");
  const turnoSelect = document.querySelector("select[name='turno_id']");
  const horaInicioInput = document.getElementById("hora-inicio");
  const horaFimInput = document.getElementById("hora-fim");
  const hsDiaInput = document.getElementById("hs-dia");
  const turmaInput = document.getElementById("turma");
  const scheduleIdInput = document.getElementById("schedule-id");
  const anoInput = document.getElementById("ano");
  const scheduleForm = document.getElementById("schedule-form");
  const dataInicioInput = document.getElementById("data-inicio");
  const dataFimInput = document.getElementById("data-fim");
  const endDateAlert = document.getElementById("end-date-alert");
  const instructorsList = document.getElementById("instructors-list");
  const isNewSchedule = scheduleForm?.dataset?.isNew === "1";

  function updateInstructorButtons() {
    const rows = Array.from(instructorsList.querySelectorAll(".instructor-row"));
    rows.forEach((row) => {
      const removeBtn = row.querySelector(".instructor-remove");
      if (!removeBtn) return;
      removeBtn.disabled = rows.length <= 1;
    });
  }

  function buildInstructorRow(selectedValue = "") {
    const firstSelect = instructorsList.querySelector("select[name='instrutor_ids']");
    const row = document.createElement("div");
    row.className = "instructor-row";
    row.innerHTML = `
      <select name="instrutor_ids" class="guided-field" required>${firstSelect ? firstSelect.innerHTML : ""}</select>
      <button type="button" class="button instructor-add instructor-add-primary">+</button>
      <button type="button" class="button ghost instructor-remove">-</button>
    `;
    const select = row.querySelector("select[name='instrutor_ids']");
    if (select && selectedValue) {
      select.value = selectedValue;
    }
    return row;
  }

  function refreshGuidedFieldState() {
    if (!scheduleForm) return;
    scheduleForm.querySelectorAll(".guided-field").forEach((field) => {
      const value = String(field.value || "").trim();
      field.classList.toggle("is-filled", value !== "");
    });
  }

  function handleInstructorButtons(event) {
    const addBtn = event.target.closest(".instructor-add");
    const removeBtn = event.target.closest(".instructor-remove");
    if (!addBtn && !removeBtn) return;

    const row = event.target.closest(".instructor-row");
    if (!row) return;

    if (addBtn) {
      const newRow = buildInstructorRow();
      instructorsList.appendChild(newRow);
      updateInstructorButtons();
      refreshGuidedFieldState();
      return;
    }

    if (removeBtn) {
      const rows = instructorsList.querySelectorAll(".instructor-row");
      if (rows.length > 1) {
        row.remove();
      }
      updateInstructorButtons();
      refreshGuidedFieldState();
    }
  }

  function atualizarAmbiente() {
    const option = ambienteSelect.selectedOptions[0];
    if (!option) return;
    pavimentoInput.value = option.dataset.floor || "";
    if (!qtdAlunosInput.value || qtdAlunosInput.dataset.auto === "true") {
      qtdAlunosInput.value = option.dataset.capacity || "";
      qtdAlunosInput.dataset.auto = "true";
    }
  }

  function atualizarCurso() {
    const option = cursoSelect.selectedOptions[0];
    if (!option) return;
    chTotalInput.value = option.dataset.ch || "";
  }

  function calcularHsDia() {
    if (!horaInicioInput.value || !horaFimInput.value) {
      hsDiaInput.value = "";
      return;
    }
    const [startH, startM] = horaInicioInput.value.split(":").map(Number);
    const [endH, endM] = horaFimInput.value.split(":").map(Number);
    const start = startH * 60 + startM;
    const end = endH * 60 + endM;
    if (end <= start) {
      hsDiaInput.value = "";
      return;
    }
    const diff = end - start;
    const hours = String(Math.floor(diff / 60)).padStart(2, "0");
    const minutes = String(diff % 60).padStart(2, "0");
    hsDiaInput.value = `${hours}:${minutes}`;
  }

  function atualizarTurno() {
    const option = turnoSelect.selectedOptions[0];
    if (!option) return;
    if (!horaInicioInput.value || horaInicioInput.dataset.auto === "true") {
      if (option.dataset.start) {
        horaInicioInput.value = option.dataset.start;
      }
      horaInicioInput.dataset.auto = "true";
    }
    if (!horaFimInput.value || horaFimInput.dataset.auto === "true") {
      if (option.dataset.end) {
        horaFimInput.value = option.dataset.end;
      }
      horaFimInput.dataset.auto = "true";
    }
    if (option.dataset.hs) {
      hsDiaInput.value = option.dataset.hs;
    } else {
      calcularHsDia();
    }
  }

  function aplicarMascaraData(input) {
    const digits = input.value.replace(/\D/g, "").slice(0, 8);
    const day = digits.slice(0, 2);
    const month = digits.slice(2, 4);
    const year = digits.slice(4, 8);
    let masked = day;
    if (month) masked += `/${month}`;
    if (year) masked += `/${year}`;
    input.value = masked;
  }

  function validarData(input) {
    const value = input.value.trim();
    return /^\d{2}\/\d{2}\/\d{4}$/.test(value);
  }

  function aplicarMascaraTurma() {
    const digits = turmaInput.value.replace(/\D/g, "").slice(0, 9);
    const part1 = digits.slice(0, 4);
    const part2 = digits.slice(4, 6);
    const part3 = digits.slice(6, 9);
    let masked = part1;
    if (part2) masked += `.${part2}`;
    if (part3) masked += `.${part3}`;
    turmaInput.value = masked;
  }

  function limparFormularioNovaOferta() {
    if (!isNewSchedule || !scheduleForm) return;
    // Mantem apenas os campos automÃ¡ticos (ID/Ano) e limpa os demais.
    const preserveIds = new Set(["schedule-id"]);
    scheduleForm.querySelectorAll("input, textarea, select").forEach((field) => {
      const tag = field.tagName.toLowerCase();
      const type = (field.type || "").toLowerCase();
      if (preserveIds.has(field.id || "")) return;
      if (field.name === "schedule_id") return;
      if (type === "checkbox") {
        field.checked = false;
        return;
      }
      if (tag === "select") {
        field.selectedIndex = 0;
        return;
      }
      field.value = "";
    });
    if (instructorsList) {
      const rows = Array.from(instructorsList.querySelectorAll(".instructor-row"));
      rows.forEach((row, idx) => {
        if (idx > 0) row.remove();
      });
      const firstSelect = instructorsList.querySelector("select[name='instrutor_ids']");
      if (firstSelect) firstSelect.selectedIndex = 0;
      updateInstructorButtons();
    }
    showEndDateAlert("", false);
    refreshGuidedFieldState();
  }

  function showEndDateAlert(message, isError = false) {
    if (!endDateAlert) return;
    if (!message) {
      endDateAlert.textContent = "";
      endDateAlert.classList.remove("alert-error");
      endDateAlert.style.display = "none";
      return;
    }
    endDateAlert.textContent = message;
    endDateAlert.classList.toggle("alert-error", isError);
    endDateAlert.style.display = "block";
  }

  function getDiasExecucao() {
    return Array.from(document.querySelectorAll("input[name='dias_execucao']"))
      .filter((input) => input.checked)
      .map((input) => input.value);
  }

  async function atualizarDataFinal() {
    if (!anoInput || !dataInicioInput || !dataFimInput) return;
    const year = anoInput.value.trim();
    const start = dataInicioInput.value.trim();
    const dias = getDiasExecucao();
    const courseId = cursoSelect.value;
    const shiftId = turnoSelect.value;

    if (!year || !start || !dias.length || !courseId || !shiftId) {
      dataFimInput.readOnly = false;
      showEndDateAlert("", false);
      return;
    }

    if (start.length < 10) {
      dataFimInput.readOnly = false;
      showEndDateAlert("", false);
      return;
    }

    if (!validarData(dataInicioInput)) {
      dataFimInput.readOnly = false;
      showEndDateAlert("Informe uma data inicial vÃ¡lida para calcular a data final.", true);
      return;
    }

    const params = new URLSearchParams({
      year,
      start,
      days: dias.join(","),
      course_id: courseId,
      shift_id: shiftId,
    });

    try {
      const response = await fetch(`/programming/compute-end-date?${params.toString()}`);
      const payload = await response.json();
      if (!response.ok) {
        dataFimInput.readOnly = false;
        showEndDateAlert(payload.error || "NÃ£o foi possÃ­vel calcular a data final.", true);
        return;
      }
      dataFimInput.value = payload.end_date || "";
      dataFimInput.readOnly = true;
      showEndDateAlert("Data final calculada automaticamente com base no calendÃ¡rio.", false);
    } catch (error) {
      dataFimInput.readOnly = false;
      showEndDateAlert("Falha ao calcular a data final. Tente novamente.", true);
    }
  }

  async function atualizarIdOferta() {
    if (!isNewSchedule || !scheduleIdInput || !anoInput) return;
    const year = anoInput.value.trim();
    if (!/^\d{4}$/.test(year)) return;
    try {
      const response = await fetch(`/programming/next-offer-id?year=${encodeURIComponent(year)}`);
      const payload = await response.json();
      if (!response.ok) return;
      if (payload.offer_id) {
        scheduleIdInput.value = payload.offer_id;
      }
    } catch (_error) {
      // Mantem a ID atual se a consulta falhar.
    }
  }

  qtdAlunosInput.addEventListener("input", () => {
    qtdAlunosInput.dataset.auto = "false";
  });
  ambienteSelect.addEventListener("change", () => {
    qtdAlunosInput.dataset.auto = "true";
    atualizarAmbiente();
  });
  turnoSelect.addEventListener("change", atualizarTurno);
  turnoSelect.addEventListener("change", atualizarDataFinal);
  horaInicioInput.addEventListener("input", () => {
    horaInicioInput.dataset.auto = "false";
    calcularHsDia();
  });
  horaFimInput.addEventListener("input", () => {
    horaFimInput.dataset.auto = "false";
    calcularHsDia();
  });

  document.querySelectorAll(".date-mask").forEach((input) => {
    input.addEventListener("input", () => aplicarMascaraData(input));
    input.addEventListener("blur", () => {
      if (input.value && !validarData(input)) {
        input.classList.add("input-error");
      } else {
        input.classList.remove("input-error");
      }
    });
  });

  turmaInput.addEventListener("input", aplicarMascaraTurma);
  aplicarMascaraTurma();

  if (isNewSchedule) {
    limparFormularioNovaOferta();
    calcularHsDia();
    atualizarIdOferta();
  } else {
    atualizarAmbiente();
    atualizarCurso();
    atualizarTurno();
    calcularHsDia();
    atualizarDataFinal();
  }
  refreshGuidedFieldState();

  document.getElementById("schedule-form").addEventListener("submit", (event) => {
    const invalidDates = Array.from(document.querySelectorAll(".date-mask")).some(
      (input) => !validarData(input)
    );
    const turmaValida = /^\d{4}\.\d{2}\.\d{3}$/.test(turmaInput.value.trim());
    if (invalidDates || !turmaValida) {
      event.preventDefault();
      if (!turmaValida) {
        turmaInput.classList.add("input-error");
      }
    }
  });

  cursoSelect.addEventListener("change", () => {
    atualizarCurso();
    atualizarDataFinal();
  });

  dataInicioInput.addEventListener("input", atualizarDataFinal);
  anoInput.addEventListener("input", () => {
    atualizarDataFinal();
    atualizarIdOferta();
  });

  document.querySelectorAll("input[name='dias_execucao']").forEach((input) => {
    input.addEventListener("change", atualizarDataFinal);
  });

  if (instructorsList) {
    instructorsList.addEventListener("click", handleInstructorButtons);
    updateInstructorButtons();
  }
  if (scheduleForm) {
    scheduleForm.addEventListener("input", refreshGuidedFieldState);
    scheduleForm.addEventListener("change", refreshGuidedFieldState);
  }
  atualizarIdOferta();

  // Evita restauraÃ§Ã£o de valores antigos quando a pÃ¡gina volta do cache do navegador.
  window.addEventListener("pageshow", (event) => {
    if (!isNewSchedule) return;
    if (event.persisted) {
      limparFormularioNovaOferta();
      atualizarIdOferta();
    }
  });
</script>
{% endblock %}

