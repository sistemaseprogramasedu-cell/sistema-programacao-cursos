{% extends "base.html" %}
{% set title = "Cadastro de Oferta" %}
{% block content %}
<form class="form" method="post" id="schedule-form">
  <div class="frame">
    <div class="frame-header">
      <h3>Cadastro de Oferta</h3>
    </div>
    <div class="form-row">
      <div>
        <label>ID</label>
        <input name="schedule_id" value="{{ schedule.id if schedule else schedule_id }}" readonly required />
      </div>
      <div>
        <label>Ano</label>
        <input name="ano" value="{{ schedule.ano if schedule else '' }}" required />
      </div>
      <div>
        <label>Mês</label>
        <select name="mes" required>
          {% for month in months %}
            <option value="{{ month.value }}" {% if schedule and schedule.mes|string == month.value %}selected{% endif %}>{{ month.label }}</option>
          {% endfor %}
        </select>
      </div>
    </div>
  </div>

  <div class="frame">
    <div class="frame-header">
      <h3>Dados da Oferta</h3>
    </div>
    <div class="form-row">
      <div>
        <label>Turno</label>
        <select name="turno_id" required>
          {% for shift in shifts %}
            <option value="{{ shift.id }}" data-start="{{ shift.horario_inicio }}" data-end="{{ shift.horario_fim }}" data-hs="{{ shift.hs_dia }}" {% if schedule and schedule.turno_id == shift.id %}selected{% endif %}>{{ shift.nome }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label>Pavimento</label>
        <input name="pavimento" id="pavimento" value="{{ schedule.pavimento if schedule else '' }}" readonly required />
      </div>
      <div>
        <label>Ambiente</label>
        <select name="sala_id" id="ambiente-select" required>
          {% for room in rooms %}
            <option value="{{ room.id }}" data-floor="{{ room.pavimento }}" data-capacity="{{ room.capacidade }}" {% if schedule and schedule.sala_id == room.id %}selected{% endif %}>{{ room.nome }}</option>
          {% endfor %}
        </select>
      </div>
    </div>
    <div class="form-row">
      <div>
        <label>QTD. Alunos</label>
        <input name="qtd_alunos" id="qtd-alunos" value="{{ schedule.qtd_alunos if schedule else '' }}" required />
      </div>
      <div>
        <label>Curso</label>
        <select name="curso_id" id="curso-select" required>
          {% for course in courses %}
            <option value="{{ course.id }}" data-ch="{{ course.carga_horaria_total }}" {% if schedule and schedule.curso_id == course.id %}selected{% endif %}>{{ course.nome }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label>Recurso/Tipo</label>
        <input name="recurso_tipo" value="{{ schedule.recurso_tipo if schedule else '' }}" />
      </div>
    </div>
    <div class="form-row">
      <div>
        <label>Data Inicial (DD/MM/AAAA)</label>
        <input name="data_inicio" class="date-mask" value="{{ schedule.data_inicio if schedule else '' }}" required />
      </div>
      <div>
        <label>Data Final (DD/MM/AAAA)</label>
        <input name="data_fim" class="date-mask" value="{{ schedule.data_fim if schedule else '' }}" required />
      </div>
      <div>
        <label>CH</label>
        <input name="ch_total" id="ch-total" value="{{ schedule.ch_total if schedule else '' }}" readonly required />
      </div>
    </div>
    <div class="form-row">
      <div>
        <label>Nº da Turma</label>
        <input name="turma" id="turma" value="{{ schedule.turma if schedule else '' }}" placeholder="0000.00.000" pattern="\\d{4}\\.\\d{2}\\.\\d{3}" required />
      </div>
      <div>
        <label>Hora Inicial</label>
        <input name="hora_inicio" id="hora-inicio" class="time-field" value="{{ schedule.hora_inicio if schedule else '' }}" type="time" required />
      </div>
      <div>
        <label>Hora Final</label>
        <input name="hora_fim" id="hora-fim" class="time-field" value="{{ schedule.hora_fim if schedule else '' }}" type="time" required />
      </div>
      <div>
        <label>Hs/Dia</label>
        <input id="hs-dia" class="time-field" value="{{ schedule.hs_dia if schedule else '' }}" readonly />
      </div>
    </div>
    <div class="form-row">
      <div>
        <label>Analista</label>
        <select name="analista_id" required>
          {% for collaborator in analysts %}
            <option value="{{ collaborator.id }}" {% if schedule and schedule.analista_id == collaborator.id %}selected{% endif %}>{{ collaborator.nome_sobrenome }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label>Instrutor</label>
        <select name="instrutor_id" required>
          {% for collaborator in instructors %}
            <option value="{{ collaborator.id }}" {% if schedule and schedule.instrutor_id == collaborator.id %}selected{% endif %}>{{ collaborator.nome_sobrenome }}</option>
          {% endfor %}
        </select>
      </div>
    </div>
    <div class="form-row">
      <div>
        <label>Dias de execução</label>
        <div class="checkbox-grid">
          {% set dias = schedule.dias_execucao if schedule and schedule.dias_execucao else [] %}
          {% for day in ["SEG", "TER", "QUA", "QUI", "SEX", "SÁB"] %}
            <label class="checkbox-item">
              <input type="checkbox" name="dias_execucao" value="{{ day }}" {% if day in dias %}checked{% endif %} />
              <span>{{ day }}</span>
            </label>
          {% endfor %}
        </div>
      </div>
      <div>
        <label>Observações</label>
        <textarea name="observacoes">{{ schedule.observacoes if schedule else '' }}</textarea>
      </div>
    </div>
  </div>
  <div class="actions">
    <button class="button" type="submit">Salvar</button>
    <a class="button ghost" href="/programming">Cancelar</a>
  </div>
</form>

<script>
  const ambienteSelect = document.getElementById("ambiente-select");
  const pavimentoInput = document.getElementById("pavimento");
  const qtdAlunosInput = document.getElementById("qtd-alunos");
  const cursoSelect = document.getElementById("curso-select");
  const chTotalInput = document.getElementById("ch-total");
  const turnoSelect = document.querySelector("select[name='turno_id']");
  const horaInicioInput = document.getElementById("hora-inicio");
  const horaFimInput = document.getElementById("hora-fim");
  const hsDiaInput = document.getElementById("hs-dia");
  const turmaInput = document.getElementById("turma");

  function atualizarAmbiente() {
    const option = ambienteSelect.selectedOptions[0];
    if (!option) return;
    pavimentoInput.value = option.dataset.floor || "";
    if (!qtdAlunosInput.value || qtdAlunosInput.dataset.auto === "true") {
      qtdAlunosInput.value = option.dataset.capacity || "";
      qtdAlunosInput.dataset.auto = "true";
    }
  }

  function atualizarCurso() {
    const option = cursoSelect.selectedOptions[0];
    if (!option) return;
    chTotalInput.value = option.dataset.ch || "";
  }

  function calcularHsDia() {
    if (!horaInicioInput.value || !horaFimInput.value) {
      hsDiaInput.value = "";
      return;
    }
    const [startH, startM] = horaInicioInput.value.split(":").map(Number);
    const [endH, endM] = horaFimInput.value.split(":").map(Number);
    const start = startH * 60 + startM;
    const end = endH * 60 + endM;
    if (end <= start) {
      hsDiaInput.value = "";
      return;
    }
    const diff = end - start;
    const hours = String(Math.floor(diff / 60)).padStart(2, "0");
    const minutes = String(diff % 60).padStart(2, "0");
    hsDiaInput.value = `${hours}:${minutes}`;
  }

  function atualizarTurno() {
    const option = turnoSelect.selectedOptions[0];
    if (!option) return;
    if (!horaInicioInput.value || horaInicioInput.dataset.auto === "true") {
      if (option.dataset.start) {
        horaInicioInput.value = option.dataset.start;
      }
      horaInicioInput.dataset.auto = "true";
    }
    if (!horaFimInput.value || horaFimInput.dataset.auto === "true") {
      if (option.dataset.end) {
        horaFimInput.value = option.dataset.end;
      }
      horaFimInput.dataset.auto = "true";
    }
    if (option.dataset.hs) {
      hsDiaInput.value = option.dataset.hs;
    } else {
      calcularHsDia();
    }
  }

  function aplicarMascaraData(input) {
    const digits = input.value.replace(/\D/g, "").slice(0, 8);
    const day = digits.slice(0, 2);
    const month = digits.slice(2, 4);
    const year = digits.slice(4, 8);
    let masked = day;
    if (month) masked += `/${month}`;
    if (year) masked += `/${year}`;
    input.value = masked;
  }

  function validarData(input) {
    const value = input.value.trim();
    return /^\d{2}\/\d{2}\/\d{4}$/.test(value);
  }

  function aplicarMascaraTurma() {
    const digits = turmaInput.value.replace(/\D/g, "").slice(0, 9);
    const part1 = digits.slice(0, 4);
    const part2 = digits.slice(4, 6);
    const part3 = digits.slice(6, 9);
    let masked = part1;
    if (part2) masked += `.${part2}`;
    if (part3) masked += `.${part3}`;
    turmaInput.value = masked;
  }

  qtdAlunosInput.addEventListener("input", () => {
    qtdAlunosInput.dataset.auto = "false";
  });
  ambienteSelect.addEventListener("change", () => {
    qtdAlunosInput.dataset.auto = "true";
    atualizarAmbiente();
  });
  cursoSelect.addEventListener("change", atualizarCurso);
  turnoSelect.addEventListener("change", atualizarTurno);
  horaInicioInput.addEventListener("input", () => {
    horaInicioInput.dataset.auto = "false";
    calcularHsDia();
  });
  horaFimInput.addEventListener("input", () => {
    horaFimInput.dataset.auto = "false";
    calcularHsDia();
  });

  document.querySelectorAll(".date-mask").forEach((input) => {
    input.addEventListener("input", () => aplicarMascaraData(input));
    input.addEventListener("blur", () => {
      if (input.value && !validarData(input)) {
        input.classList.add("input-error");
      } else {
        input.classList.remove("input-error");
      }
    });
  });

  turmaInput.addEventListener("input", aplicarMascaraTurma);
  aplicarMascaraTurma();

  atualizarAmbiente();
  atualizarCurso();
  atualizarTurno();
  calcularHsDia();

  document.getElementById("schedule-form").addEventListener("submit", (event) => {
    const invalidDates = Array.from(document.querySelectorAll(".date-mask")).some(
      (input) => !validarData(input)
    );
    const turmaValida = /^\d{4}\.\d{2}\.\d{3}$/.test(turmaInput.value.trim());
    if (invalidDates || !turmaValida) {
      event.preventDefault();
      if (!turmaValida) {
        turmaInput.classList.add("input-error");
      }
    }
  });
</script>
{% endblock %}
